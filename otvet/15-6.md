# Домашнее задание к занятию 6. «Troubleshooting» - Рыбакин Алексей

<details>
<summary> ## Задача 1 </summary>

Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD-операция в MongoDB и её 
нужно прервать. 

Вы как инженер поддержки решили произвести эту операцию:

- напишите список операций, которые вы будете производить для остановки запроса пользователя;
- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB.

</details>
```sql
Определим opid операции командой:  
       db.currentOp()
Завершим принудительно операцию по opid
       db.killOp()

Используя Database Profiler, отловить медленные операции. С помощью executionStats проанализировать.
Попробовать оптимизировать:

1. Установить по максимуму время выполнения запросовmaxTimeMS() 
2. И опимизировать: использовать индексы, настроить шардинг, запросы 
```

<details>
<summary> ## Задача 2 </summary>

Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причём отношение количества записанных key-value-значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 

При масштабировании сервиса до N реплик вы увидели, что:

- сначала происходит рост отношения записанных значений к истекшим,
- Redis блокирует операции записи.

Как вы думаете, в чём может быть проблема?

</details>
```sql
Закончились ресурсы оперативной памяти. и механизм ttl - не правильно настроен параметр `maxmemory-policy` в конфигурационном файле Redis..
Как указанно в рекомендованной документации "Задержка, вызванная истечением срока действия" 
Redis блокирует процесы записи на время очистки ключей с истёкшим скоком действия пока процент етих значений не достикнет <25. 
```

<details>
<summary> ## Задача 3 </summary>

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей в таблицах базы
пользователи начали жаловаться на ошибки вида:
```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```

Как вы думаете, почему это начало происходить и как локализовать проблему?

Какие пути решения этой проблемы вы можете предложить?

</details>
```sql
При дословном переводе с Яндекса Мы видим "Ошибка интерфейса: (Ошибка интерфейса) 2013: Потеряно соединение с сервером MySQL во время выбора запроса..... "
В документации MySQL ошибке посвящена  [эта](https://dev.mysql.com/doc/refman/8.0/en/error-lost-connection.html) статья

Перечислены три возможные причины:
Иногда милионы строк отправляются как часть одного или нескольких запросов, рекомендуют увеличить параметр net_read_timeout
Мало времени для установки соединения. Можно изменить connect_timeout с нескольких сек до 10 сек и больше если медленное соединение или большое растояние
Слишком большие значения, превышает размер буфера, заданного в max_allowed_packet. Нужно его увеличить.

Еще возможны неправильные настройки конфигурации клиента или сервера могут вызвать разрыв соединения. 

Поправить перечисленные параметры:
Увеличить на сервере wait_timeout, max_allowed_packet, net_write_timeout и net_read_timeout. 
Уменьшить pool_recycle, сделать меньше wait_timeout
Если ошибка пропадёт, то рандомно возвращать по одному в исходное состояние, так можно локализовать проблему.
```

<details>
<summary> ## Задача 4 </summary>

Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объёмом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

Как вы думаете, что происходит?

Как бы вы решили эту проблему?

</details>

```sql
Сообщение `postmaster invoked oom-killer` что процес `postmaster` активыровал механизм `OOM Killer`
Значит системе нехватает оперативной памяти. И процесом `OOM Killer` завершает процес `postmaster` для освобождения ресурсов для ОС на снове выбора [очков не годности](https://interface31.ru/tech_it/2022/09/linux---nachinayushhim-chto-takoe-oom-killer-i-kak-on-rabotaet.html). 

Можно в ручную в настройках OOM killer повысить "очки негодности" процесу postmaster до -17 и тогда он будет защищён от OOM Killer-a. 
Либо увеличить оперативку в системе, но это не всегда возможно, (финансово) и эта дополнительная память тот же может закончится.
```
